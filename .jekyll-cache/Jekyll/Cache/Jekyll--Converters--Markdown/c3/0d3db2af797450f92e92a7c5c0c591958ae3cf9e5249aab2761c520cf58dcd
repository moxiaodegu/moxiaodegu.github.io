I"¥:<p>åœ¨é¡¹ç›®ä¸­ï¼Œç»å¸¸ä¼šç¢°åˆ°è¿™æ ·çš„éœ€æ±‚ï¼šç”¨æˆ·åœ¨è¾“å…¥æ¡†è¾“å…¥æ•°æ®ï¼Œéœ€è¦å®æ—¶è°ƒç”¨åç«¯ APIï¼Œæ‹¿åˆ°ç»“æœæ˜¾ç¤ºåœ¨é¡µé¢ä¸Šã€‚å¦‚æœç”¨ä¼ ç»Ÿæ–¹å¼ä¸€èˆ¬å®ç°æ–¹å¼æ˜¯åœ¨è¾“å…¥æ¡†ä¸Šç»‘å®šä¸€ä¸ª keydown æˆ–è€… keyup äº‹ä»¶ï¼Œç„¶åæ¯æ¬¡è¾“å…¥å€¼ä»¥åéƒ½è°ƒç”¨ä¸€æ¬¡åç«¯ APIï¼Œæ‹¿åˆ°è¿”å›æ•°æ®ã€‚è¿™æ ·ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ¯”å¦‚æˆ‘è¾“å…¥â€™limeiâ€™ï¼Œ<code class="language-plaintext highlighter-rouge">l</code> <code class="language-plaintext highlighter-rouge">li</code> <code class="language-plaintext highlighter-rouge">lim</code> <code class="language-plaintext highlighter-rouge">lime</code> <code class="language-plaintext highlighter-rouge">limei</code>è¿™äº”æ¬¡ keydown/keyup åˆ†åˆ«ä¼šè°ƒç”¨ä¸€æ¬¡ APIã€‚è¿™äº”ä¸ª APIæœ‰äº”ä¸ª Responseï¼Œæˆ‘æœ€åæƒ³è¦â€™limeiâ€™çš„ç»“æœï¼Œç”±äºè¿™äº”ä¸ª API çš„ response é¡ºåºä¸å¯æ§ï¼Œå¯èƒ½æœ€åè¿”å›â€™liâ€™çš„ç»“æœã€‚è¿™ç§æ–¹æ³•ä¸ä»…æ•ˆç‡ä½è€Œä¸”ç»“æœæ­£ç¡®æ€§æ²¡åŠæ³•ä¿è¯ã€‚</p>

<p>è¿™ç¯‡æ–‡ç« ä¼šä»‹ç»å¦‚ä½•åœ¨ RxJS ä¸­ç»“åˆæ“ä½œç¬¦<code class="language-plaintext highlighter-rouge">debounceTime</code> <code class="language-plaintext highlighter-rouge">map</code>  <code class="language-plaintext highlighter-rouge">filter</code>  <code class="language-plaintext highlighter-rouge">distinctUntilChanged</code> å’Œ<code class="language-plaintext highlighter-rouge">switchMap</code>å®ç°ï¼šè¾“å…¥å®Œâ€œlimeiâ€ä¹‹ååªè°ƒç”¨ä¸€æ¬¡ APIï¼Œæœ€åæ‹¿åˆ°è¿™ä¸ª API è¿”å›çš„è¾“å…¥æ˜¾ç¤ºåœ¨é¡µé¢ä¸Šã€‚</p>

<p>æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªæœç´¢ github ç”¨æˆ·çš„åŠŸèƒ½ï¼Œé¡µé¢ä¸Šæœ‰ä¸€ä¸ªè¾“å…¥æ¡†ï¼Œåœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥ github ç”¨æˆ·åï¼Œç„¶åæŠŠæœç´¢ç»“æœæ˜¾ç¤ºåœ¨é¡µé¢ä¸Šï¼š</p>

<p><img src="https://limeii.github.io/assets/images/posts/rxjs/rxjs-searchinput01.png" alt="rxjs-searchable-input" height="100%" width="100%" /></p>

<p>å¦‚æœæ²¡æœ‰åŒ¹é…çš„ç”¨æˆ·ï¼Œæ˜¾ç¤ºå¦‚ä¸‹ï¼š</p>

<p><img src="https://limeii.github.io/assets/images/posts/rxjs/rxjs-searchinput02.png" alt="rxjs-searchable-input" height="100%" width="100%" /></p>

<p>æˆ‘ä»¬å…ˆæ¥å®šä¹‰ä¸€ä¸ª Service å¦‚ä¸‹ï¼š</p>

<p>ç¤ºä¾‹ä»£ç ç”¨çš„æ˜¯ Angular+RxJSï¼ŒAPI æ˜¯ã€<a href="https://developer.github.com/v3/search/#search-users">Github Search user API</a>ã€‘, ç¤ºä¾‹ä»£ç åœ¨è¿™é‡Œï¼šã€<a href="https://github.com/LiMeii/angular-rxjs">angular-rxjs</a>ã€‘</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">class</span> <span class="nx">RxjsSearchableInputService</span> <span class="p">{</span>

    <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">http</span><span class="p">:</span> <span class="nx">HttpClient</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

    <span class="nx">searchUser</span><span class="p">(</span><span class="nx">val</span><span class="p">:</span> <span class="kr">any</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="kd">get</span><span class="o">&lt;</span><span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">SearchResult</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://api.github.com/search/users?q=</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">val</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>
                <span class="nx">map</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">),</span>
                <span class="nx">catchError</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">something went wrong, </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">error</span><span class="p">);</span>
                    <span class="k">return</span> <span class="k">of</span><span class="p">([]);</span>
                <span class="p">})</span>
            <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å®šä¹‰ä¸€ä¸ª component å¦‚ä¸‹ï¼š</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">class</span> <span class="nx">RxjsSearchableInputComponent</span> <span class="k">implements</span> <span class="nx">OnInit</span><span class="p">,</span> <span class="nx">OnDestroy</span> <span class="p">{</span>

    <span class="nl">users</span><span class="p">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">User</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">onSearchUser$</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Subject</span><span class="o">&lt;</span><span class="nx">KeyboardEvent</span><span class="o">&gt;</span><span class="p">();</span>

    <span class="nx">validSearch$</span><span class="p">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span><span class="p">;</span>
    <span class="nx">emptySearch$</span><span class="p">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span><span class="p">;</span>

    <span class="nl">subscription</span><span class="p">:</span> <span class="nx">Subscription</span><span class="p">;</span>
    <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">rxjsSearchableInputService</span><span class="p">:</span> <span class="nx">RxjsSearchableInputService</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

    <span class="nx">ngOnInit</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">validSearch$</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">onSearchUser$</span>
            <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>
                <span class="nx">debounceTime</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span>
                <span class="nx">map</span><span class="p">(</span><span class="nx">event</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="nx">HTMLInputElement</span><span class="o">&gt;</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">value</span><span class="p">),</span>
                <span class="nx">distinctUntilChanged</span><span class="p">(),</span>
                <span class="nx">filter</span><span class="p">(</span><span class="nx">input</span> <span class="o">=&gt;</span> <span class="nx">input</span> <span class="o">!==</span> <span class="dl">""</span><span class="p">),</span>
                <span class="nx">switchMap</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">rxjsSearchableInputService</span><span class="p">.</span><span class="nx">searchUser</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span>
            <span class="p">)</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">emptySearch$</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">onSearchUser$</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>
            <span class="nx">debounceTime</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span>
            <span class="nx">map</span><span class="p">(</span><span class="nx">event</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="o">&lt;</span><span class="nx">HTMLInputElement</span><span class="o">&gt;</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">value</span><span class="p">),</span>
            <span class="nx">filter</span><span class="p">(</span><span class="nx">input</span> <span class="o">=&gt;</span> <span class="nx">input</span> <span class="o">===</span> <span class="dl">""</span><span class="p">),</span>
            <span class="nx">switchMap</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="k">of</span><span class="p">([]))</span>
        <span class="p">)</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">subscription</span> <span class="o">=</span> <span class="nx">merge</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">validSearch$</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">emptySearch$</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">resp</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">resp</span> <span class="o">&amp;&amp;</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">items</span> <span class="o">&amp;&amp;</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">resp</span> <span class="k">as</span> <span class="nx">SearchResult</span><span class="p">;</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">users</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">items</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">users</span> <span class="o">=</span> <span class="p">[];</span>
                <span class="p">}</span>
            <span class="p">})</span>
    <span class="p">}</span>

    <span class="nx">ngOnDestroy</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">subscription</span><span class="p">.</span><span class="nx">unsubscribe</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>component å¯¹åº”çš„ html æ–‡ä»¶å¦‚ä¸‹ï¼š</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"margin-large"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container-flex margin-small"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"margin-right-small"</span><span class="nt">&gt;&lt;strong&gt;</span> Search Github user: <span class="nt">&lt;/strong&gt;&lt;/div&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">(keyup)=</span><span class="s">"onSearchUser$.next($event)"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">*ngFor=</span><span class="s">"let user of users"</span> <span class="na">style=</span><span class="s">"margin: 20px"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container-flex"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"font: 0.9em;width:20%"</span><span class="nt">&gt;&lt;strong&gt;</span>User Name: <span class="nt">&lt;/strong&gt;</span>{{user.login}}<span class="nt">&lt;/div&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"font:0.9em;width:10%"</span><span class="nt">&gt;&lt;strong&gt;</span>ID: <span class="nt">&lt;/strong&gt;</span>{{user.id}}<span class="nt">&lt;/div&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"font:0.9em;width:30%"</span><span class="nt">&gt;&lt;strong&gt;</span>GitHub URL: <span class="nt">&lt;/strong&gt;</span>{{user.url}}<span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">*ngIf=</span><span class="s">"!users.length"</span> <span class="na">class=</span><span class="s">"margin-small"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">style=</span><span class="s">"color:red"</span><span class="nt">&gt;</span>no search result!<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>
<p>åœ¨ componet ä¸­å…ˆå®šä¹‰ä¸€ä¸ª onSearchUser$ subjectï¼Œç„¶ååœ¨ inputä¸Š ç»‘å®šä¸€ä¸ª keyup äº‹ä»¶<code class="language-plaintext highlighter-rouge">(keyup)="onSearchUser$.next($event)"</code>ï¼Œæ¯æ¬¡è¾“å…¥æ¡†æœ‰è¾“å…¥å˜åŒ–çš„æ—¶å€™ï¼ŒonSearchUser$ éƒ½ä¼šå‘é€å½“å‰è¾“å…¥æ¡†çš„å€¼ã€‚</p>

<p>ç„¶ååœ¨ component ä¸­å®šä¹‰ä¸¤ä¸ª Observableï¼švalidSearch$ å’Œ emptySearch$ï¼ŒvalidSearch$ æ˜¯æ¯éš”1ç§’æ‹¿åˆ° input æ¡†ä¸­çš„éç©ºå€¼ï¼Œå¹¶ä¸”æ˜¯æœ¬æ¬¡æ‹¿åˆ°çš„å€¼å’Œä¸Šæ¬¡çš„å€¼ä¸ä¸€æ ·çš„æƒ…å†µä¸‹è°ƒç”¨ searchUser API æŠŠæœç´¢ç»“åˆæ˜¾ç¤ºåœ¨é¡µé¢ä¸Šã€‚emptySearch$ æ˜¯æ¯éš”1ç§’æ‹¿åˆ° input æ¡†ä¸­çš„ç©ºå€¼ï¼Œå¹¶ä¸è°ƒç”¨ APIï¼Œç›´æ¥è¿”å›ä¸€ä¸ªç©ºçš„ç”¨æˆ·åˆ—è¡¨ã€‚åœ¨ validSearch$ ä¸­ç”¨ switchMap çš„åŸå› æ˜¯ï¼šæœ¬æ¬¡è°ƒç”¨ API çš„æ—¶å€™ï¼Œä¸Šä¸€æ¬¡çš„ API å¦‚æœè¿˜æ²¡æœ‰è¿”å›ï¼ŒswitchMap ä¼šå–æ¶ˆä¸Šä¸€æ¬¡çš„ APIï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯æ¯æ¬¡ API è¿”å›çš„ç»“æœæ˜¯æ­£ç¡®çš„ã€‚</p>

<p>æœ€åå†ç”¨ merge æŠŠ emptySearch$ï¼ŒvalidSearch$ ä¸¤ä¸ª Observable åˆå¹¶ã€‚</p>

<p>ç”¨ RxJS å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œä»£ç æ˜¯ä¸æ˜¯éå¸¸ç®€æ´ï¼</p>
:ET