I"k<p>åœ¨è¿™ç¯‡æ–‡ç« ä¸­ä¼šä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>

<ul>
  <li>
    <p>ä»€ä¹ˆæ˜¯ Tree Shakingï¼Œä»¥åŠå®ƒå¯¹æ€§èƒ½çš„å½±å“ã€‚</p>
  </li>
  <li>
    <p>å¦‚ä½•è®© Angular(6.0+) çš„ Service å®ç° Tree Shakingã€‚</p>
  </li>
  <li>
    <p>åœ¨ webpack4 çš„é¡¹ç›®ä¸­ï¼Œæ€ä¹ˆå®ç° Tree Shakingã€‚</p>
  </li>
</ul>

<p>åœ¨æ–‡ç« ã€<a href="https://limeii.github.io/2019/08/angular-customize-webpack/">Angularï¼šå¦‚ä½•åœ¨Angular(8.0)ä¸­é…ç½®Webpack</a>ã€‘æåˆ°äº† Angular å†…ç½®çš„ç¼–è¯‘æ‰“åŒ…æ–¹å¼ä¼šæ‰§è¡Œ Tree Shakingï¼Œå¯ä»¥æé«˜ Angular åº”ç”¨çš„æ€§èƒ½ã€‚é‚£æˆ‘ä»¬å…ˆçœ‹ä¸‹ä»€ä¹ˆæ˜¯ Tree Shakingã€‚</p>

<h2 id="tree-shaking">Tree Shaking</h2>

<p>Tree Shaking æ˜¯æŒ‡åœ¨ç¼–è¯‘æ‰“åŒ…è¿‡ç¨‹ä¸­ï¼Œä¼šæŠŠé‚£äº›å®šä¹‰å¥½çš„ä»£ç ä½†æ˜¯åˆæ²¡æœ‰è¢«è°ƒç”¨çš„ä»£ç å»æ‰ï¼Œä¸æŠŠè¿™äº›æ²¡ç”¨åˆ°çš„ä»£ç æ‰“åŒ…åˆ°æœ€åçš„ bundle æ–‡ä»¶é‡Œï¼Œä»è€Œå¯ä»¥å‡å° bundle æ–‡ä»¶çš„ä½“ç§¯ï¼Œæé«˜åº”ç”¨æ€§èƒ½ã€‚å¯ä»¥æŠŠæ•´ä¸ªåº”ç”¨æƒ³è±¡æˆä¸€æ£µæ ‘ï¼Œfunction/component/service/lib å¥½æ¯”æ˜¯æ ‘å¶ï¼Œè€Œé‚£äº›å®šä¹‰ä½†åˆæ²¡æœ‰è¢«è°ƒç”¨çš„ function/component/service/lib å¥½æ¯”æ˜¯æ¯æ ‘å¶ï¼ŒTree Shaking å°±æ˜¯æŠŠé‚£äº›æ¯æ ‘å¶ä»æ ‘ä¸Šæ‘‡ä¸‹å»ã€‚</p>

<p>Angular å†…ç½®çš„æ‰“åŒ…æ–¹å¼åœ¨<code class="language-plaintext highlighter-rouge">ng build --prod</code>ä¼šå¯ç”¨ Tree Shakingï¼Œåœ¨<code class="language-plaintext highlighter-rouge">ng build</code>å¼€å‘æ¨¡å¼ä¸‹ç¼–è¯‘ä¸ä¼šç”¨ Tree Shakingã€‚æˆ‘ä»¬å¯ä»¥å¯¹æ¯” Angular é¡¹ç›®çš„å¼€å‘å’Œç”Ÿäº§ç¼–è¯‘ç»“æœï¼Œæ¥çœ‹çœ‹ Tree Shaking çš„æ•ˆæœï¼Œå…·ä½“ä»£ç å¯ä»¥åœ¨ã€<a href="https://github.com/LiMeii/angular-performance">angular-performance</a>ã€‘æŸ¥çœ‹ã€‚</p>

<p>é¦–å…ˆå®šä¹‰ä¸€ä¸ª typescript çš„ moduleï¼Œexport ä¸¤ä¸ª functionï¼šsquareï¼Œcubeï¼›å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// common-utility.ts</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">square</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">this is square function in commonutility</span><span class="dl">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">cube</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">this is cube function in commonutility</span><span class="dl">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ç„¶ååœ¨ DashboardComponent ä¸­åªå¼•ç”¨ cube æ–¹æ³•ï¼š</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//dashboard.module.ts</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Component</span><span class="p">,</span> <span class="nx">OnInit</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@angular/core</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">cube</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../../shared/common-utility</span><span class="dl">"</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Component</span><span class="p">({</span>
    <span class="na">templateUrl</span><span class="p">:</span> <span class="dl">"</span><span class="s2">./dashboard.component.html</span><span class="dl">"</span>
<span class="p">})</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">DashboardComponent</span> <span class="k">implements</span> <span class="nx">OnInit</span> <span class="p">{</span>
    <span class="nx">ngOnInit</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">here is the cube result </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">cube</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>ç”¨<code class="language-plaintext highlighter-rouge">ng serve</code>æŠŠé¡¹ç›®è·‘èµ·æ¥ä»¥åï¼Œåœ¨ console é‡Œä¼šæœ‰ä»¥ä¸‹çš„è¾“å‡ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>this is cube function in commonutility
dashboard.component.ts:12 here is the cube result 27
</code></pre></div></div>

<p>ä¹‹å‰è¯´è¿‡åœ¨<code class="language-plaintext highlighter-rouge">ng build</code>å¼€å‘æ¨¡å¼ä¸‹ç¼–è¯‘ä¸ä¼šç”¨ Tree Shakingï¼Œæ‰€ä»¥ç¼–è¯‘ä»¥åçš„ bundle æ–‡ä»¶é‡Œä¼šæœ‰<code class="language-plaintext highlighter-rouge">square</code>æ–¹æ³•çš„æºç ï¼Œæˆ‘ä»¬<code class="language-plaintext highlighter-rouge">ng build</code>ç¼–è¯‘ä»£ç çœ‹ä¸‹ç»“æœï¼š</p>

<p>åœ¨ç¼–è¯‘åçš„ bunlde æ–‡ä»¶ï¼šmodules-dashboard-dashboard-module-es5.js é‡Œï¼Œæˆ‘ä»¬èƒ½çœ‹åˆ°å¦‚ä¸‹ä»£ç ï¼Œæ²¡æœ‰ Tree Shakingï¼Œ<code class="language-plaintext highlighter-rouge">square(x)</code>æ–¹æ³•åœ¨æ•´ä¸ªé¡¹ç›®é‡Œéƒ½æ²¡æœ‰è¢«è°ƒç”¨ï¼Œä½†æ˜¯ç¼–è¯‘æ‰“åŒ…çš„æ—¶å€™ï¼Œè¿˜æ˜¯æŠŠæ•´ä¸ªæ–¹æ³•æ”¾è¿›äº†æœ€åçš„ bundle æ–‡ä»¶é‡Œï¼Œåœ¨ bundle æ–‡ä»¶çš„ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/***/</span> <span class="dl">"</span><span class="s2">./src/app/shared/common-utility.ts</span><span class="dl">"</span><span class="p">:</span>
<span class="cm">/*!******************************************!*\
  !*** ./src/app/shared/common-utility.ts ***!
  \******************************************/</span>
<span class="cm">/*! exports provided: square, cube */</span>
<span class="cm">/***/</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">module</span><span class="p">,</span> <span class="nx">__webpack_exports__</span><span class="p">,</span> <span class="nx">__webpack_require__</span><span class="p">)</span> <span class="p">{</span>

<span class="dl">"</span><span class="s2">use strict</span><span class="dl">"</span><span class="p">;</span>
<span class="nx">__webpack_require__</span><span class="p">.</span><span class="nx">r</span><span class="p">(</span><span class="nx">__webpack_exports__</span><span class="p">);</span>
<span class="cm">/* harmony export (binding) */</span> <span class="nx">__webpack_require__</span><span class="p">.</span><span class="nx">d</span><span class="p">(</span><span class="nx">__webpack_exports__</span><span class="p">,</span> <span class="dl">"</span><span class="s2">square</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">square</span><span class="p">;</span> <span class="p">});</span>
<span class="cm">/* harmony export (binding) */</span> <span class="nx">__webpack_require__</span><span class="p">.</span><span class="nx">d</span><span class="p">(</span><span class="nx">__webpack_exports__</span><span class="p">,</span> <span class="dl">"</span><span class="s2">cube</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">cube</span><span class="p">;</span> <span class="p">});</span>
<span class="kd">function</span> <span class="nx">square</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">this is square function in commonutility</span><span class="dl">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">cube</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">this is cube function in commonutility</span><span class="dl">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***/</span> <span class="p">})</span>
</code></pre></div></div>

<p>æˆ‘ä»¬å†æ¥è¯•ä¸€ä¸‹<code class="language-plaintext highlighter-rouge">ng build --prod</code>å¯ç”¨ Tree Shakingï¼Œå› ä¸º<code class="language-plaintext highlighter-rouge">ng build --prod</code>ä¸ä»…ä¼šåš Tree Shaking è¿˜ä¼šåš Minification å’Œ Uglificationï¼Œæ‰€ä»¥æœ€åçš„ç¼–è¯‘ä»£ç éƒ½æ˜¯è¢«å¤„ç†è¿‡çš„ã€‚ä¸èƒ½ç›´è§‚çš„çœ‹ä»£ç ï¼Œä½†æ˜¯åœ¨<code class="language-plaintext highlighter-rouge">square</code>å’Œ<code class="language-plaintext highlighter-rouge">cube</code>é‡Œéƒ½æœ‰ console logï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨æœ€åç¼–è¯‘ bundle æ–‡ä»¶ï¼š3-es5.55d98a7c1ad4d4f5ce12.js é‡Œç”¨å…³é”®å­—â€˜commonutilityâ€™æ¥æœç´¢æŸ¥çœ‹ã€‚ç»“æœå¦‚ä¸‹ï¼š</p>

<p><img src="https://limeii.github.io/assets/images/posts/angular/angular-tree-shaking01.png" alt="angular-tree-shaking" height="100%" width="100%" /></p>

<p>â€œthis is square function in commonutilityâ€å¹¶æ²¡æœ‰åœ¨æœ€åçš„ bundle æ–‡ä»¶é‡Œï¼Œè¯´æ˜å¯ç”¨ Tree Shaking ä¹‹åä¸ä¼šæŠŠ square æ‰“åŒ…è¿›æœ€åçš„ bundle æ–‡ä»¶é‡Œã€‚</p>

<h2 id="å¦‚ä½•è®©-angular60-çš„-service-å®ç°-tree-shaking">å¦‚ä½•è®© Angular(6.0+) çš„ Service å®ç° Tree Shaking</h2>

<p>Angular6 å‘å¸ƒäº†ä¸€é¡¹æ–°åŠŸèƒ½ï¼šTree Shakeable Providersï¼Œè¿™ä¸ªæ–°çš„åŠŸèƒ½æ˜¯ç”¨æ¥è®© Angular ä¸­çš„ service ä¹Ÿå¯ä»¥ Tree Shakingã€‚åœ¨æ­¤ä¹‹å‰ï¼ŒAngular ä¸­çš„ service éƒ½æ˜¯ä¾èµ–æ³¨å…¥çš„ï¼Œservice éƒ½æ˜¯é€šè¿‡ @Injectable è£…é¥°å™¨å®šä¹‰ï¼Œæ¯”å¦‚å®šä¹‰ä¸€ä¸ª AService å¦‚ä¸‹ï¼š</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@angular/core</span><span class="dl">"</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Injectable</span><span class="p">()</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">AService</span> <span class="p">{</span>
    <span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">this is Aservice, no matter using or not, Aservice will awalys be bundled.</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>åœ¨ component/module é‡Œå¼•ç”¨ service éƒ½éœ€è¦å…ˆ import ç„¶åå† providers å…ƒæ•°æ®é‡ŒåŠ ä¸Šå¯¹åº”çš„ serviceï¼Œæ¯”å¦‚åœ¨ AppModule å¼•å…¥ AService çš„å†™æ³•å¦‚ä¸‹ï¼š</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">......</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">AService</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./shared/service/a.service</span><span class="dl">"</span>

<span class="p">@</span><span class="nd">NgModule</span><span class="p">({</span>
  <span class="p">.....</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[</span><span class="nx">AService</span><span class="p">],</span>
  <span class="na">bootstrap</span><span class="p">:</span> <span class="p">[</span><span class="nx">AppComponent</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">AppModule</span> <span class="p">{</span> <span class="p">}</span>
</code></pre></div></div>

<p>Angular åœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œå› ä¸ºå·²ç»æœ‰<code class="language-plaintext highlighter-rouge">import { AService }</code>è¯­å¥ï¼Œé‚£ä¹ˆä¸ç®¡è¿™ä¸ª AService æœ‰æ²¡æœ‰è¢«è°ƒç”¨ï¼Œå¯¹ Angular æ¥è¯´å¹¶ä¸å¥½åŒºåˆ† AService æ˜¯å¦è¢«çœŸæ­£è°ƒç”¨ï¼Œæ‰€ä»¥ä¸ç®¡æ˜¯å¦è°ƒç”¨ï¼Œæœ€å AService éƒ½ä¼šè¢«æ‰“åŒ…è¿› bundle æ–‡ä»¶ï¼Œæ²¡åŠæ³•åš Tree Shakingã€‚</p>

<p>Angular6.0 å‘å¸ƒçš„æ–°åŠŸèƒ½ï¼šTree Shakeable Providersï¼Œå°±æ˜¯ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œé€šè¿‡<code class="language-plaintext highlighter-rouge">providedIn</code>å…ƒæ•°æ®é€‰é¡¹å®šä¹‰è¯¥ service æ˜¯ç”¨åœ¨å“ªä¸ª module é‡Œï¼Œç„¶ååœ¨å¯¹åº”çš„ module é‡Œå°±ä¸éœ€è¦æ˜¾ç¤º<code class="language-plaintext highlighter-rouge">import { ServiceName }</code>ï¼Œæ²¡æœ‰ import è¯­å¥ä»¥åï¼Œé‚£ä¹ˆ Angular åœ¨ç¼–è¯‘çš„æ—¶å€™å°±å¾ˆå¾ˆå®¹æ˜“åˆ¤æ–­ service åˆ°åº•æœ‰æ²¡æœ‰è¢«è°ƒç”¨ï¼Œä»è€Œå¯ä»¥å¾ˆå®¹æ˜“å®ç°å¯¹ service åš Tree Shakingã€‚æˆ‘ä»¬å…·ä½“æ¥çœ‹çœ‹ä»£ç ç¤ºä¾‹ï¼š</p>

<p>å®šä¹‰ä¸€ä¸ª BServiceï¼Œ<code class="language-plaintext highlighter-rouge">providedIn: "root"</code>è¡¨ç¤º BService ç”¨åœ¨äº† root moduleï¼ˆAppModuleï¼‰ï¼Œç„¶ååœ¨ AppComponent è°ƒç”¨ BServiceï¼Œä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//BService</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@angular/core</span><span class="dl">"</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Injectable</span><span class="p">({</span>
    <span class="na">providedIn</span><span class="p">:</span> <span class="dl">"</span><span class="s2">root</span><span class="dl">"</span>
<span class="p">})</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">BService</span> <span class="p">{</span>
    <span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">this is Bservice, there has one component using this, so Bservice will be bundled</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//AppComponent</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Component</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@angular/core</span><span class="dl">"</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">BService</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./shared/service/b.service</span><span class="dl">"</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Component</span><span class="p">({</span>
  <span class="na">selector</span><span class="p">:</span> <span class="dl">"</span><span class="s2">app-root</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">templateUrl</span><span class="p">:</span> <span class="dl">"</span><span class="s2">./app.component.html</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">styleUrls</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">./app.component.css</span><span class="dl">"</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">AppComponent</span> <span class="p">{</span>
  <span class="nx">title</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">angular-performance</span><span class="dl">"</span><span class="p">;</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">bService</span><span class="p">:</span> <span class="nx">BService</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ä¸ºäº†å¯¹æ¯”ï¼Œæˆ‘ä»¬åœ¨å®šä¹‰ä¸€ä¸ª CServiceï¼Œ<code class="language-plaintext highlighter-rouge">providedIn: "root"</code>è¡¨ç¤º CService ç”¨åœ¨äº† root moduleï¼ˆAppModuleï¼‰ï¼Œä½†æ˜¯ä¸å†ä»»ä½•åœ°æ–¹è°ƒç”¨ CServiceï¼Œä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@angular/core</span><span class="dl">"</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Injectable</span><span class="p">({</span>
    <span class="na">providedIn</span><span class="p">:</span> <span class="dl">"</span><span class="s2">root</span><span class="dl">"</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">CService</span> <span class="p">{</span>
    <span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">this is Cservice, there has no component using this, so Cservice won't be bundled.</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å†ç”¨<code class="language-plaintext highlighter-rouge">ng build --prod</code>ç¼–è¯‘æ‰“åŒ…ï¼Œservice æ–‡ä»¶ä¼šæ‰“åŒ…åˆ°<code class="language-plaintext highlighter-rouge">main-es5.396328bc020fc5aa2168.js</code>bundle æ–‡ä»¶é‡Œï¼ŒåŒæ ·é€šè¿‡å…³é”®å­—æœç´¢çš„æ–¹å¼æ¥çœ‹ä¸‹ç»“æœï¼š</p>

<p>æœç´¢ï¼šAServiceï¼Œå¯ä»¥çœ‹åˆ° AService æ²¡æœ‰ç”¨<code class="language-plaintext highlighter-rouge">providedIn: "root"</code>ï¼Œè€Œä¸”æ²¡æœ‰è¢«è°ƒç”¨ï¼Œæœ‰ Tree Shakingï¼Œä½†æ˜¯å› ä¸ºåœ¨ AppModule æœ‰<code class="language-plaintext highlighter-rouge">import { AService }</code>ï¼Œä¸ç®¡æ˜¯å¦è¢«è°ƒç”¨éƒ½ä¼šæ‰“åŒ…è¿›æœ€åçš„ bundle æ–‡ä»¶ã€‚
<img src="https://limeii.github.io/assets/images/posts/angular/angular-tree-shaking02.png" alt="angular-tree-shaking" height="100%" width="100%" /></p>

<p>æœç´¢ï¼šBServiceï¼Œå¯ä»¥çœ‹åˆ° BService ç”¨<code class="language-plaintext highlighter-rouge">providedIn: "root"</code>ï¼Œåœ¨ AppModule ä¸éœ€è¦<code class="language-plaintext highlighter-rouge">import { BService }</code>ï¼Œå¹¶ä¸”åœ¨ AppComponent é‡Œè°ƒç”¨ï¼Œæœ‰ Tree Shakingï¼Œä¼šè¢«æ‰“åŒ…è¿›æœ€åçš„ bundle æ–‡ä»¶ã€‚
<img src="https://limeii.github.io/assets/images/posts/angular/angular-tree-shaking03.png" alt="angular-tree-shaking" height="100%" width="100%" /></p>

<p>æœç´¢ï¼šCServiceï¼Œå¯ä»¥çœ‹åˆ° CService ç”¨<code class="language-plaintext highlighter-rouge">providedIn: "root"</code>ï¼Œåœ¨ AppModule ä¸éœ€è¦<code class="language-plaintext highlighter-rouge">import { CService }</code>ï¼Œä½†æ˜¯æ²¡æœ‰è¢«è°ƒç”¨ï¼Œæœ‰ Tree Shakingï¼Œä¸ä¼šè¢«æ‰“åŒ…è¿›æœ€åçš„ bundle æ–‡ä»¶ã€‚ 
<img src="https://limeii.github.io/assets/images/posts/angular/angular-tree-shaking04.png" alt="angular-tree-shaking" height="100%" width="100%" /></p>

<h2 id="åœ¨-webpack4-çš„é¡¹ç›®ä¸­æ€ä¹ˆå®ç°-tree-shaking">åœ¨ webpack4 çš„é¡¹ç›®ä¸­ï¼Œæ€ä¹ˆå®ç° Tree Shaking</h2>

<p>å¦‚æœä¸ç”¨ Angular å†…ç½®çš„æ‰“åŒ…æ–¹å¼åš Tree Shakingï¼Œé‚£ä¹ˆåœ¨ webpack4 æ€ä¹ˆå®ç° Tree Shakingï¼Ÿåœ¨ webpack å®˜æ–¹æ–‡æ¡£ï¼šã€<a href="https://webpack.js.org/guides/tree-shaking/">Webpack Tree Shaking</a>ã€‘æœ‰ä»‹ç»ç»“åˆ <code class="language-plaintext highlighter-rouge">"sideEffects": false</code>å’Œ <code class="language-plaintext highlighter-rouge">mode: "production"</code>å®ç° Tree Shakingï¼Œæˆ‘å°è¯•ç”¨å½“å‰æœ€æ–°çš„ webpack ç‰ˆæœ¬ï¼š<code class="language-plaintext highlighter-rouge">webpack@4.39.2</code>æ­äº†ä¸€ä¸ªé¡¹ç›®ï¼Œå°è¯•åœ¨ webpack4 ä¸­ä½¿ç”¨ Tree Shakingï¼Œå‘ç°è·Ÿå®˜æ–¹æ–‡æ¡£ä»‹ç»è¿˜æ˜¯æœ‰ç‚¹å‡ºå…¥ã€‚</p>

<p>é¦–å…ˆç”¨<code class="language-plaintext highlighter-rouge">npm init</code>åˆå§‹åŒ–äº†ä¸€ä¸ªé¡¹ç›®ï¼Œæºç åœ¨è¿™é‡Œï¼šã€<a href="https://github.com/LiMeii/webpack4-practice">webpack4-practice</a>ã€‘ï¼Œç„¶åå®‰è£… webpack/webpack-cli ç­‰ç­‰åŒ…ã€‚é…ç½®å¥½ webpack config æ–‡ä»¶ã€‚å…·ä½“å¦‚ä¸‹ï¼š</p>

<p>ã€<a href="https://github.com/LiMeii/webpack4-practice/blob/master/config/webpack.common.config.js">webpack4-practice/config/webpack.common.config.js</a>ã€‘</p>

<p>ã€<a href="https://github.com/LiMeii/webpack4-practice/blob/master/config/webpack.dev.config.js">webpack4-practice/config/webpack.dev.config.js</a>ã€‘</p>

<p>ã€<a href="https://github.com/LiMeii/webpack4-practice/blob/master/config/webpack.prod.config.js">webpack4-practice/config/webpack.prod.config.js</a>ã€‘</p>

<p>åœ¨æ ¹ç›®å½•ä¸‹ï¼Œåˆ›å»ºå¦‚ä¸‹æ–‡ä»¶ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|----scr
      |----index.html
      |----main.js
      |----shared
           |----common-utility.js

</code></pre></div></div>

<p>common-utility.js ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">function</span> <span class="nx">square</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">this is square function in commonutility</span><span class="dl">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nx">cube</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">this is cube function in commonutility</span><span class="dl">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>åœ¨ main.js ä¸­è°ƒç”¨ cube æ–¹æ³•ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">cube</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./shared/common-utility</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">the result for cube(5) is </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">cube</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span>
</code></pre></div></div>
<blockquote>
<p>
æ­¤æ—¶å¹¶æ²¡æœ‰æŒ‰å®˜æ–¹æ–‡æ¡£ä»‹ç»çš„é‚£æ ·åœ¨ package.json æ–‡ä»¶ä¸­è®¾ç½®"sideEffects": falseã€‚åªæ˜¯å¯¹ dev å’Œ prod çš„ mode åˆ†åˆ«è®¾ç½® mode:"development" å’Œ mode:"production"ã€‚
</p>
</blockquote>

<p>è¿è¡Œ<code class="language-plaintext highlighter-rouge">npm run build:dev</code>ï¼Œåœ¨æ‰“åŒ…å‡ºæ¥çš„ bundle æ–‡ä»¶ï¼šmain.07bdac8643ee4eaf7a5d.js ä¸­å¯ä»¥çœ‹åˆ°<code class="language-plaintext highlighter-rouge">square</code>æ–¹æ³•è™½ç„¶æ²¡æœ‰è°ƒç”¨ï¼Œä½†è¿˜æ˜¯è¢«æ‰“åŒ…è¿›æ¥äº†ï¼Œè¯´æ˜<code class="language-plaintext highlighter-rouge">mode:"development"</code>æ¨¡å¼ä¸‹ä¸ä¼š Tree Shakingï¼Œ</p>

<p>è¿è¡Œ<code class="language-plaintext highlighter-rouge">npm run build:prod</code>ï¼Œåœ¨æ‰“åŒ…å‡ºæ¥çš„ bundle æ–‡ä»¶ï¼šmain.a60a09c27b85b5bcc81f.js ä¸­åªèƒ½çœ‹åˆ°<code class="language-plaintext highlighter-rouge">cube</code>æ–¹æ³•è¢«æ‰“åŒ…ï¼Œè¯´æ˜<code class="language-plaintext highlighter-rouge">mode:"production"</code>æ¨¡å¼ä¸‹ï¼Œwebpack4 é»˜è®¤åš Tree Shakingã€‚</p>

<p>æ¥ç€æŒ‰å®˜æ–¹æ–‡æ¡£çš„ä»‹ç»ï¼Œåœ¨ package.json æ–‡ä»¶ä¸­è®¾ç½® sideEffectsï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"webpack4-practice"</span><span class="err">,</span><span class="w">
</span><span class="nl">"sideEffects"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></code></pre></div></div>
<p>æˆ–è€…æ˜¯ï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"webpack4-practice"</span><span class="err">,</span><span class="w">
  </span><span class="nl">"sideEffects"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"./src/shared/common-utility.js"</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>æœ€åç¼–è¯‘çš„ç»“æœè·Ÿä¸Šé¢ä¸ç”¨ sideEffects çš„æ•ˆæœä¸€æ¨¡ä¸€æ ·ï¼Œè¯´æ˜è‡³å°‘åœ¨<code class="language-plaintext highlighter-rouge">webpack@4.39.2</code>ç‰ˆæœ¬ä¸­ï¼Œåªè¦è®¾ç½®äº†<code class="language-plaintext highlighter-rouge">mode:"production"</code>æ¨¡å¼å°±å¯ä»¥æ‰§è¡Œ Tree Shakingï¼Œè·Ÿ<code class="language-plaintext highlighter-rouge">sideEffects</code>æ²¡ä»€ä¹ˆå…³ç³»ã€‚</p>

<blockquote>
<p>
éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒWebpack å†…ç½®çš„ Tree Shaking åªå¯¹ ES6 module è¯­æ³•æœ‰ç”¨ï¼Œå¯¹é‚£äº›ç”¨ Babel æŠŠ ES6 modules ç¼–è¯‘æˆ CommonJS modules ä¸èµ·ä½œç”¨ã€‚
</p>
</blockquote>

<h2 id="å…¶ä»–-tree-shaking-å·¥å…·">å…¶ä»– Tree Shaking å·¥å…·</h2>

<ul>
  <li><a href="https://github.com/rollup/rollup">Rollup</a></li>
  <li><a href="https://github.com/google/closure-compiler">Google Closure Compiler</a></li>
</ul>
:ET