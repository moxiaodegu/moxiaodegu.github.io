I"µw<p>åœ¨è¿™ç¯‡æ–‡ç« ä¸­ä¼šä»‹ç»ä»¥ä¸‹å†…å®¹ï¼š</p>
<ul>
  <li>ä¸ºä»€ä¹ˆ Angular éœ€è¦ç¼–è¯‘ã€‚</li>
  <li>Angular ç¼–è¯‘æœºåˆ¶ï¼šJiT vs AoTã€‚</li>
  <li>AoT çš„å·¥ä½œåŸç†ï¼ˆngcï¼‰ã€‚</li>
  <li>AoT å¯¹æ€§èƒ½çš„å½±å“ã€‚</li>
</ul>

<h2 id="ä¸ºä»€ä¹ˆ-angular-éœ€è¦ç¼–è¯‘">ä¸ºä»€ä¹ˆ Angular éœ€è¦ç¼–è¯‘</h2>

<p>Angular æ˜¯åŸºäº TypeScriptï¼Œç¼–è¯‘æ‰“åŒ…çš„æ—¶å€™ä¼šç”¨ tsc å°† TypeScript ç¼–è¯‘æˆ es5 æ–‡ä»¶ï¼Œè¿™æ ·åœ¨æµè§ˆå™¨ JavaScript Virtual Machines (VM) å¯ä»¥ç›´æ¥è¿è¡Œ es5 ä»£ç ã€‚é‚£ä¹ˆ Angular ä¸ºä»€ä¹ˆè¿˜éœ€è¦ç¼–è¯‘å‘¢ï¼Ÿåœ¨ Angular ä¸­é™¤äº† TypeScript ä¹‹å¤–ï¼Œè¿˜æœ‰ HTML æ¨¡æ¿æ–‡ä»¶ï¼Œåœ¨è¿™äº›æ¨¡æ¿æ–‡ä»¶é‡Œæœ‰ Angular è‡ªå¸¦çš„ç»„ä»¶ã€æŒ‡ä»¤ã€ç®¡é“ç­‰ç­‰ï¼Œä¸ºäº†è®©æµè§ˆå™¨å¯ä»¥è¯†åˆ«å’Œè¿è¡Œè¿™äº›ä¸œè¥¿ï¼Œé‚£ä¹ˆå°±éœ€è¦ç”¨ Angular ç¼–è¯‘å™¨æŠŠè¿™äº›ç¼–è¯‘æˆæµè§ˆå™¨å¯è¯†åˆ«å’Œè¿è¡Œçš„ es5 ä»£ç ã€‚</p>

<h2 id="angular-ç¼–è¯‘æœºåˆ¶jit-vs-aot">Angular ç¼–è¯‘æœºåˆ¶ï¼šJiT vs AoT</h2>

<p>Angular çš„ç¼–è¯‘å™¨æœ‰ä¸¤ç§æ‰§è¡Œæœºåˆ¶ï¼šJiT å’Œ AoTï¼Œ<code class="language-plaintext highlighter-rouge">ng build</code>å’Œ<code class="language-plaintext highlighter-rouge">ng serve</code>æ˜¯ JiT çš„ç¼–è¯‘æ–¹å¼ï¼Œ<code class="language-plaintext highlighter-rouge">ng build --prod</code> <code class="language-plaintext highlighter-rouge">ng build --aot</code> æˆ–è€…<code class="language-plaintext highlighter-rouge">ng serve --aot</code>æ˜¯ AoT çš„ç¼–è¯‘æ–¹å¼ã€‚ä¸€å¥è¯æ¦‚æ‹¬ä¸¤è€…çš„åŒºåˆ«ï¼šAngular ç¼–è¯‘å™¨ï¼ˆngcï¼‰æ‰§è¡Œçš„æ—¶æœºä¸ä¸€æ ·ï¼ŒJiT æ˜¯æµè§ˆå™¨åœ¨æ¸²æŸ“é¡µé¢çš„æ—¶å€™å…ˆæŠŠ Angular ç¼–è¯‘å™¨ä¸‹è½½åˆ°æœ¬åœ°ï¼Œç„¶åæŠŠ HTML æ¨¡æ¿ç¼–è¯‘æˆæµè§ˆå™¨å¯è¯†åˆ«è¿è¡Œçš„ es5 ä»£ç ï¼›AoT æ˜¯é¡¹ç›®åœ¨æ‰“åŒ…çš„æ—¶å€™å°±æŠŠ HTML æ¨¡æ¿ç¼–è¯‘æˆæµè§ˆå™¨å¯è¯†åˆ«è¿è¡Œçš„ es5 ä»£ç ï¼Œåœ¨æµè§ˆå™¨æ¸²æŸ“æ—¶ä¸éœ€è¦ä¸‹è½½ Angular ç¼–è¯‘å™¨ä¹Ÿä¸éœ€è¦ç¼–è¯‘ï¼Œç›´æ¥è¿è¡Œè¿™äº›ä»£ç å°±å¯ä»¥äº†ã€‚æ•´ä¸ªæµç¨‹å¦‚ä¸‹ï¼š</p>

<h3 id="jit">JiT</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- åŸºäº TypeScript å¼€å‘ Angular é¡¹ç›®
- ç”¨ tsc ç¼–è¯‘ Angular é¡¹ç›®
- æ‰“åŒ…
- Minification
- éƒ¨ç½²

å½“ç”¨æˆ·è®¿é—®è¿™ä¸ªç½‘ç«™çš„æ—¶å€™ï¼š

- ä¸‹è½½ç›¸å…³çš„é™æ€èµ„æºæ–‡ä»¶ï¼ŒåŒ…æ‹¬ Angular ç¼–è¯‘å™¨ï¼ˆ@angular/compilerï¼‰
- å¯åŠ¨ Angular
- Angular ç¼–è¯‘å™¨æ‰§è¡Œç¼–è¯‘ï¼ˆngcï¼‰
- é¡µé¢æ¸²æŸ“

</code></pre></div></div>

<h3 id="aot">AoT</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- åŸºäº TypeScript å¼€å‘ Angular é¡¹ç›®
- ç¼–è¯‘ Angular é¡¹ç›®
  - å…ˆæŠŠæ¨¡æ¿å’Œ component ç¼–è¯‘æˆ TypeScript/es6ï¼ˆngcï¼‰
  - å†æŠŠ TypeScript ç¼–è¯‘æˆ es5 (tsc)
- æ‰“åŒ…
- Minification
- éƒ¨ç½²

å½“ç”¨æˆ·è®¿é—®ç½‘ç«™çš„æ—¶å€™ï¼š

- ä¸‹è½½ç›¸å…³çš„é™æ€èµ„æºæ–‡ä»¶ï¼Œä¸éœ€è¦ä¸‹è½½ Angular ç¼–è¯‘å™¨ï¼ˆ@angular/compilerï¼‰
- å¯åŠ¨ Angular
- é¡µé¢æ¸²æŸ“
</code></pre></div></div>

<p>ä»ä¸Šé¢çš„æµç¨‹å¯ä»¥çœ‹å‡ºï¼Œç”¨ AoT ç¼–è¯‘æ–¹å¼æ‰“åŒ…ï¼Œåœ¨é¡µé¢æ¸²æŸ“çš„æ—¶å€™ä¸éœ€è¦ä¸‹è½½ Angular ç¼–è¯‘å™¨ä»£ç ï¼Œä¹Ÿä¸éœ€è¦æ‰§è¡Œç¼–è¯‘ï¼Œè€Œæ˜¯ç›´æ¥æ¸²æŸ“é¡µé¢ã€‚ä»æ€§èƒ½ä¸Šæ¥è¯´ï¼ŒAoT è¦èƒœè¿‡ JiTã€‚é™¤äº†ç¼–è¯‘æ—¶æœºä¸åŒï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ä»£ç æ¥çœ‹çœ‹ä¸¤ç§ç¼–è¯‘æ–¹å¼çš„ bundle æ–‡ä»¶æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚åˆ›å»ºä¸€ä¸ª Angular é¡¹ç›®ï¼Œç„¶åè¿è¡Œ<code class="language-plaintext highlighter-rouge">ng build</code> <code class="language-plaintext highlighter-rouge">ng build --prod</code>æ¥çœ‹çœ‹æœ€åç¼–è¯‘æ–‡ä»¶æœ‰ä»€ä¹ˆä¸åŒã€‚</p>

<p>ç¤ºä¾‹æºç åœ¨è¿™é‡Œï¼šã€<a href="https://github.com/LiMeii/angular-performance">angular-performance</a>ã€‘</p>

<p>ä»£ç ç»“æ„å¦‚ä¸‹ï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--src
 -- app
   -- modules
     -- dashboard
       - dashboard.component.html
       - dashboard.component.ts
       - dashboard.module.ts
     -- deep-understanding-aot
       - deep-understanding-aot.component.html
       - deep-understanding-aot.component.ts
       - deep-understanding-aot.module.ts
   -- shared
 - index.html
 - main.ts
 - styles.css
</code></pre></div></div>

<p>å…¶ä¸­ deep-understanding-aot ç»„ä»¶ï¼Œç”¨æ¥æ˜¾ç¤ºå½“å‰æ—¶é—´ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// deep-understanding-aot.component.ts</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Component</span><span class="p">,</span> <span class="nx">OnInit</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@angular/core</span><span class="dl">"</span><span class="p">;</span>

<span class="p">@</span><span class="nd">Component</span><span class="p">({</span>
    <span class="na">selector</span><span class="p">:</span><span class="dl">"</span><span class="s2">app-deepunderstand-compiler</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">templateUrl</span><span class="p">:</span> <span class="dl">"</span><span class="s2">./deep-understanding-aot.component.html</span><span class="dl">"</span>
<span class="p">})</span>

<span class="k">export</span> <span class="kd">class</span> <span class="nx">DeepUnderstandingComponent</span> <span class="k">implements</span> <span class="nx">OnInit</span> <span class="p">{</span>
    <span class="k">public</span> <span class="nx">title</span> <span class="o">=</span><span class="dl">"</span><span class="s2">let's learn angular compiler togetherï¼</span><span class="dl">"</span><span class="p">;</span>
    <span class="k">public</span> <span class="nx">time</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
    <span class="nx">ngOnInit</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">setInterval</span><span class="p">(()</span><span class="o">=&gt;</span><span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">time</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
        <span class="p">},</span><span class="mi">1000</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- deep-understanding-aot.component.html --&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"margin-large"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h1&gt;&lt;/h1&gt;</span>
    <span class="nt">&lt;h2&gt;</span>here is current time:  { {  time | date: 'hh:mm:ss a'  } } <span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p><strong>è¿è¡Œ ng buildï¼ˆJiTï¼‰</strong></p>

<p>ç¼–è¯‘ä¹‹åçš„æ–‡ä»¶å¦‚ä¸‹ï¼š
<img src="/assets/images/posts/angular/angular-compiler01.png" alt="angular-compiler" height="100%" width="100%" /></p>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° vendor æ–‡ä»¶æœ€å¤§ï¼Œvendor-es5.js æœ‰3882KBï¼Œvendor-es2015.js æœ‰3856KBã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å·¥å…·ã€<a href="https://github.com/danvk/source-map-explorer">source-map-explorer</a>ã€‘æ¥çœ‹çœ‹ vendor æ–‡ä»¶é‡Œåˆ°åº•æœ‰ä»€ä¹ˆã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//å…ˆå®‰è£… source-map-explorer
npm install -g source-map-explorer

// è¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼ŒæŸ¥çœ‹ vendor-es5.js
npx source-map-explorer dist/angular-performance/vendor-es5.js
</code></pre></div></div>
<p>vendor-es5.js æ–‡ä»¶ç»“æ„å¦‚ä¸‹;
<img src="/assets/images/posts/angular/angular-compiler02.png" alt="angular-compiler" height="100%" width="100%" /></p>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å› ä¸º JiT æ˜¯åœ¨é¡µé¢æ¸²æŸ“çš„æ—¶å€™ç¼–è¯‘æ¨¡æ¿æ–‡ä»¶ï¼Œæ‰€ä»¥éœ€è¦æ‰“åŒ… compiler æºç ï¼Œcompiler æºç å°±æœ‰ 1.32Mï¼ DeepUnderstandingComponent å¯¹åº”çš„ bundle æ–‡ä»¶(JiT)æ˜¯ï¼šmodules-deep-understanding-aot-deep-understanding-aot-module-es5.jsï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æ–‡ä»¶å†…å®¹ï¼š</p>

<p><img src="/assets/images/posts/angular/angular-compiler05.png" alt="angular-compiler" height="100%" width="100%" /></p>

<p>ä»ä¸Šé¢çš„å›¾ç‰‡æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒJiT ç¼–è¯‘åœ¨æ‰“åŒ…è¿‡ç¨‹ä¸­ä¸ä¼šç¼–è¯‘æ¨¡æ¿æ–‡ä»¶ï¼ŒHTML ç›´æ¥ä»¥å†…è”çš„æ–¹å¼æ”¾åœ¨ bundle æ–‡ä»¶é‡Œï¼Œä¿ç•™äº† Angular çš„ { { } } å’Œ date pipeï¼›component åªæ˜¯æŠŠ TypeScript è¯­æ³•ç¼–è¯‘æˆäº† es5 çš„è¯­æ³•ã€‚</p>

<p><strong>è¿è¡Œ ng build:prodï¼ˆAoTï¼‰</strong></p>

<p>é»˜è®¤<code class="language-plaintext highlighter-rouge">ng build:prod</code>ä¸ä¼šäº§ç”Ÿ source map æ–‡ä»¶ï¼Œç”±äºæˆ‘ä»¬éœ€è¦ç”¨ source-map-explorer å·¥å…·åˆ†æ bundle æ–‡ä»¶ç»“æ„ï¼Œæ‰€ä»¥éœ€è¦åœ¨è¿è¡Œ<code class="language-plaintext highlighter-rouge">ng build:prod</code>ä¹Ÿäº§ç”Ÿ source map æ–‡ä»¶ã€‚éœ€è¦æ”¹åŠ¨ angular.json æ–‡ä»¶é…ç½®ï¼Œæ”¹åŠ¨å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//angular.json

      "architect": {
        "build": {
            ......
            ......
          "configurations": {
            "production": {
              ......
              ......
              "sourceMap": true, // æŠŠsourceMapè®¾ç½®ä¸ºTrue
              ......
              ......
            }
          }
        }
      }
</code></pre></div></div>

<p>ç¼–è¯‘ä¹‹åçš„æ–‡ä»¶å¦‚ä¸‹ï¼š
<img src="/assets/images/posts/angular/angular-compiler03.png" alt="angular-compiler" height="100%" width="100%" /></p>

<p>æˆ‘ä»¬çœ‹åˆ° main æ–‡ä»¶æœ€å¤§ï¼Œå…¶ä¸­ main-es5.241e3ea4617330a70446.js æœ‰275KBã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// è¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼ŒæŸ¥çœ‹main-es5.241e3ea4617330a70446.js
npx source-map-explorer dist/angular-performance/main-es5.241e3ea4617330a70446.js
</code></pre></div></div>
<p>main çš„æ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š
<img src="/assets/images/posts/angular/angular-compiler04.png" alt="angular-compiler" height="100%" width="100%" /></p>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç”±äº AoT åœ¨æ‰“åŒ…çš„æ—¶å€™ç¼–è¯‘æ¨¡æ¿æ–‡ä»¶ï¼Œæ‰€ä»¥ä¸éœ€è¦æŠŠæ‰“åŒ… compiler æºç ï¼Œbundle æ–‡ä»¶æ˜æ˜¾å‡å°äº†å¾ˆå¤šï¼DeepUnderstandingComponent å¯¹åº”çš„ bundle æ–‡ä»¶(AoT)æ˜¯4-es5.4c969b6ad4c13630ad20.jsï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹é‡Œé¢çš„å†…å®¹ï¼š</p>

<p><img src="/assets/images/posts/angular/angular-compiler06.png" alt="angular-compiler" height="100%" width="100%" /></p>

<p>æ•´ä¸ªæ–‡ä»¶éƒ½è¢« minify å’Œ uglifyï¼Œé€šè¿‡å…³é”®å­—<code class="language-plaintext highlighter-rouge">here is current time</code>æœç´¢ï¼Œå¯ä»¥çœ‹åˆ° Angular çš„ { { } } å’Œ date pipeè¿™äº›éƒ½è¢«ç¼–è¯‘ es5 ä»£ç ã€‚</p>

<p>æ¥æ€»ç»“ä¸€ä¸‹ JiT å’Œ AoT çš„ä¸»è¦åŒºåˆ«ï¼š</p>
<ul>
  <li>æ‰“åŒ…ä¹‹åçš„æ–‡ä»¶å¤§å°ä¸ä¸€æ ·ï¼Œæœ€å¤§çš„åŒºåˆ«æ˜¯ JiT éœ€è¦æŠŠ compiler æºç æ‰“åŒ…è¿› bundle æ–‡ä»¶ï¼Œè€Œ AoT ä¸éœ€è¦ã€‚</li>
  <li>bundle æ–‡ä»¶çš„å†…å®¹ä¹Ÿæœ‰å¾ˆå¤§åŒºåˆ«ï¼šJiT æŠŠ HTML æ¨¡æ¿ç›´æ¥å†…è”è¿› bundle æ–‡ä»¶ä¸åšä»»ä½•å¤„ç†ï¼ŒAoT ä¼šæŠŠ HTML æ¨¡æ¿æ–‡ä»¶ç¼–è¯‘ es5 æ–‡ä»¶ã€‚</li>
  <li>ç¼–è¯‘æ‰§è¡Œçš„æ—¶æœºä¸ä¸€æ ·ï¼ŒJiT æ˜¯åœ¨æµè§ˆå™¨é‡Œæ‰§è¡Œï¼Œéœ€è¦å†…è”çš„ HTML æ–‡ä»¶ç¼–è¯‘æˆ es5 ä»£ç ï¼›AoT æ˜¯åœ¨ç¼–è¯‘æ‰“åŒ…çš„æ—¶å€™å°±æŠŠ HTML æ–‡ä»¶ç¼–è¯‘æˆ es5 ä»£ç ã€‚</li>
</ul>

<p>æ¥ä¸‹æ¥çœ‹çœ‹ï¼ŒAoT æ˜¯å¦‚ä½•æŠŠæ¨¡æ¿æ–‡ä»¶ç¼–è¯‘æˆ es5 æ–‡ä»¶çš„ã€‚</p>

<h2 id="aotçš„å·¥ä½œåŸç†ngc">AoTçš„å·¥ä½œåŸç†ï¼ˆngcï¼‰</h2>

<p>AoT ç¼–è¯‘å®é™…åˆ†äº†ä¸¤ä¸ªæ­¥éª¤ï¼š</p>
<ul>
  <li>ç¬¬ä¸€æ­¥ï¼šç”¨ ngc æŠŠæ¨¡æ¿å’Œ component ç¼–è¯‘æˆ es6ï¼ˆæˆ–è€…æ˜¯ TypeScript ä»£ç ï¼Œå¯ä»¥åœ¨ tsconfig.json é‡Œé…ç½®ï¼‰ã€‚</li>
  <li>ç¬¬äºŒæ­¥ï¼šç”¨ tsc æŠŠè¿™äº› TypeScript ç¼–è¯‘æˆ es5ã€‚</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">ng build --prod</code>åªèƒ½çœ‹åˆ°ç¬¬äºŒæ­¥çš„ es5 æ–‡ä»¶ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰åŠæ³•çœ‹åˆ°ç¬¬ä¸€æ­¥çš„ es6 æ–‡ä»¶å‘¢ï¼Ÿå½“ç„¶æœ‰çš„ï¼Œå¯ä»¥è¿è¡Œ ngc å‘½ä»¤ï¼Œæˆ‘ä»¬åœ¨<code class="language-plaintext highlighter-rouge">package.json</code>çš„ scripts èŠ‚ç‚¹é‡ŒåŠ ä¸Šå¦‚ä¸‹å‘½ä»¤ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  "scripts": {
    ......
    ......
    "compile": "ngc"
    ......
    ......
  },

</code></pre></div></div>

<p>è¿è¡Œ<code class="language-plaintext highlighter-rouge">npm run compile</code>ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ deep-understanding-aot ç»„ä»¶åœ¨ ngc ç¼–è¯‘å®Œä»¥åæ˜¯ä»€ä¹ˆæ ·çš„ï¼š</p>

<p><img src="/assets/images/posts/angular/angular-compiler07.png" alt="angular-compiler" height="100%" width="100%" /></p>

<p>ç¼–è¯‘ä¹‹åçš„ç›®å½•æ˜¯åœ¨<code class="language-plaintext highlighter-rouge">tsconfig.json</code>æ–‡ä»¶çš„ outDir å®šä¹‰çš„ï¼Œé…ç½®å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  "compilerOptions": {
    "baseUrl": "./",
    "outDir": "./dist/out-tsc",
    "sourceMap": true,
    ......
    ......
  },
</code></pre></div></div>
<p>ngc ç¼–è¯‘çš„è¾“å‡ºæ–‡ä»¶ç›®å½•ç»“æ„å’ŒçœŸæ­£çš„é¡¹ç›®ç›®å½•ç»“æ„ä¸€æ ·ï¼Œåœ¨å¯¹åº”çš„æ–‡ä»¶å¤¹ä¸‹ä¼šæœ‰ä»¥ä¸‹æ–‡ä»¶ï¼š</p>
<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">*.metadata.json</code>ï¼šæŠŠ .ts(component/NgModule) æ–‡ä»¶é‡Œçš„ decorator ä¿¡æ¯å’Œc onstructor çš„ä¾èµ–æ³¨å…¥ä¿¡æ¯ç”¨ json çš„å½¢å¼è®°å½•ä¸‹æ¥ï¼Œä¸‹æ¬¡åœ¨äºŒæ¬¡ç¼–è¯‘çš„æ—¶å€™ä¸éœ€è¦å†ä» .ts æ–‡ä»¶é‡Œæ‹¿äº†ã€‚äºŒæ¬¡ç¼–è¯‘æ˜¯æŒ‡åœ¨è‡ªå·±é¡¹ç›®ä¸­å¼•ç”¨ç¬¬ä¸‰æ–¹åº“ï¼Œåœ¨ç¼–è¯‘è‡ªå·±é¡¹ç›®çš„æ—¶å€™éœ€è¦å¯¹ç¬¬ä¸‰æ–¹åº“è¿›è¡ŒäºŒæ¬¡ç¼–è¯‘æ‰“åŒ…ã€‚å¦‚æœæˆ‘ä»¬è‡ªå·±é¡¹ç›®è¦ç”¨AoTç¼–è¯‘ï¼Œé‚£ä¹ˆç¬¬ä¸‰æ–¹åº“å¿…é¡»è¦æä¾› .metadata.json æ–‡ä»¶ã€‚</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">*.ngfactory.js</code>ï¼šé‡Œé¢åŒ…å«äº†åˆ›å»ºç»„ä»¶ã€æ¸²æŸ“ç»„ä»¶(æ¶‰åŠ DOM æ“ä½œ)ã€æ‰§è¡Œå˜åŒ–æ£€æµ‹(è·å– oldValue å’Œ newValue å¯¹æ¯”)ã€é”€æ¯ç»„ä»¶çš„ä»£ç ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¯´çš„ component viewã€‚</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">*.js</code>ï¼šæ˜¯ .ts(component/NgModule) æ–‡ä»¶é‡Œé™¤ decorator å’Œ constructor ä¹‹å¤–çš„å†…å®¹ï¼Œç¼–è¯‘æˆäº† es6 ä»£ç ã€‚</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">*.ngsummary.json</code>ï¼šç»åŒ…å«äº† .metadata.json ä¸­æ‰€æœ‰çš„ä¿¡æ¯ï¼Œå› æ­¤å¦‚æœä½¿ç”¨äº† ngsummary.jsonï¼Œå°±ä¸éœ€è¦ .metadata.jsonäº†ã€‚</p>
  </li>
</ul>

<p>å¯¹äº<code class="language-plaintext highlighter-rouge">*.metadata.json</code> <code class="language-plaintext highlighter-rouge">*.js</code>å’Œ<code class="language-plaintext highlighter-rouge">*.ngsummary.json</code>éƒ½å¾ˆå¥½ç†è§£å°±ä¸è¯¦ç»†ä¸€ä¸€ä»‹ç»ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹<code class="language-plaintext highlighter-rouge">*.ngfactory.js</code>æ–‡ä»¶é‡Œåˆ°åº•æœ‰ä»€ä¹ˆå†…å®¹ï¼ŒåŒæ ·ä»¥ DeepUnderstandingComponent ä¸ºä¾‹ï¼Œngc äº§ç”Ÿçš„ ngfactory æ–‡ä»¶ä¸ºdeep-understanding-aot.component.ngfactory.jsï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * @fileoverview This file was generated by the Angular template compiler. Do not edit.
 *
 * @suppress {suspiciousCode,uselessCode,missingProperties,missingOverride,checkTypes}
 * tslint:disable
 */</span>
<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">i0</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@angular/core</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">i1</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@angular/common</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">i2</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./deep-understanding-aot.component</span><span class="dl">"</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">styles_DeepUnderstandingComponent</span> <span class="o">=</span> <span class="p">[];</span>
<span class="kd">var</span> <span class="nx">RenderType_DeepUnderstandingComponent</span> <span class="o">=</span> <span class="nx">i0</span><span class="p">.</span><span class="nx">Éµcrt</span><span class="p">({</span> <span class="na">encapsulation</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">styles</span><span class="p">:</span> <span class="nx">styles_DeepUnderstandingComponent</span><span class="p">,</span> <span class="na">data</span><span class="p">:</span> <span class="p">{}</span> <span class="p">});</span>
<span class="k">export</span> <span class="p">{</span> <span class="nx">RenderType_DeepUnderstandingComponent</span> <span class="k">as</span> <span class="nx">RenderType_DeepUnderstandingComponent</span> <span class="p">};</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nx">View_DeepUnderstandingComponent_0</span><span class="p">(</span><span class="nx">_l</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">i0</span><span class="p">.</span><span class="nx">Éµvid</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>

        <span class="p">[</span><span class="nx">i0</span><span class="p">.</span><span class="nx">Éµpid</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">i1</span><span class="p">.</span><span class="nx">DatePipe</span><span class="p">,</span> <span class="p">[</span><span class="nx">i0</span><span class="p">.</span><span class="nx">LOCALE_ID</span><span class="p">]),</span>
        <span class="p">(</span><span class="nx">_l</span><span class="p">()(),</span> <span class="nx">i0</span><span class="p">.</span><span class="nx">Éµeld</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="dl">"</span><span class="s2">div</span><span class="dl">"</span><span class="p">,</span> <span class="p">[[</span><span class="dl">"</span><span class="s2">class</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">margin-large</span><span class="dl">"</span><span class="p">]],</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">)),</span>
        <span class="p">(</span><span class="nx">_l</span><span class="p">()(),</span> <span class="nx">i0</span><span class="p">.</span><span class="nx">Éµeld</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="dl">"</span><span class="s2">h1</span><span class="dl">"</span><span class="p">,</span> <span class="p">[],</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">)),</span>
        <span class="p">(</span><span class="nx">_l</span><span class="p">()(),</span> <span class="nx">i0</span><span class="p">.</span><span class="nx">Éµted</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">[</span><span class="dl">""</span><span class="p">,</span> <span class="dl">""</span><span class="p">])),</span>
        <span class="p">(</span><span class="nx">_l</span><span class="p">()(),</span> <span class="nx">i0</span><span class="p">.</span><span class="nx">Éµeld</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="dl">"</span><span class="s2">h2</span><span class="dl">"</span><span class="p">,</span> <span class="p">[],</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">)),</span>
        <span class="p">(</span><span class="nx">_l</span><span class="p">()(),</span> <span class="nx">i0</span><span class="p">.</span><span class="nx">Éµted</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">[</span><span class="dl">"</span><span class="s2">here is current time: </span><span class="dl">"</span><span class="p">,</span> <span class="dl">""</span><span class="p">])),</span>
        <span class="nx">i0</span><span class="p">.</span><span class="nx">Éµppd</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">)],</span>

        <span class="kc">null</span><span class="p">,</span>

        <span class="kd">function</span> <span class="p">(</span><span class="nx">_ck</span><span class="p">,</span> <span class="nx">_v</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">_co</span> <span class="o">=</span> <span class="nx">_v</span><span class="p">.</span><span class="nx">component</span><span class="p">;</span> <span class="kd">var</span> <span class="nx">currVal_0</span> <span class="o">=</span> <span class="nx">_co</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
            <span class="nx">_ck</span><span class="p">(</span><span class="nx">_v</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">currVal_0</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">currVal_1</span> <span class="o">=</span> <span class="nx">i0</span><span class="p">.</span><span class="nx">Éµunv</span><span class="p">(</span><span class="nx">_v</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_ck</span><span class="p">(</span><span class="nx">_v</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">i0</span><span class="p">.</span><span class="nx">Éµnov</span><span class="p">(</span><span class="nx">_v</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nx">_co</span><span class="p">.</span><span class="nx">time</span><span class="p">,</span> <span class="dl">"</span><span class="s2">hh:mm:ss a</span><span class="dl">"</span><span class="p">));</span>
            <span class="nx">_ck</span><span class="p">(</span><span class="nx">_v</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">currVal_1</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nx">View_DeepUnderstandingComponent_Host_0</span><span class="p">(</span><span class="nx">_l</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">i0</span><span class="p">.</span><span class="nx">Éµvid</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">[(</span><span class="nx">_l</span><span class="p">()(),</span> <span class="nx">i0</span><span class="p">.</span><span class="nx">Éµeld</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="dl">"</span><span class="s2">ng-component</span><span class="dl">"</span><span class="p">,</span> <span class="p">[],</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">View_DeepUnderstandingComponent_0</span><span class="p">,</span> <span class="nx">RenderType_DeepUnderstandingComponent</span><span class="p">)),</span>
        <span class="nx">i0</span><span class="p">.</span><span class="nx">Éµdid</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">114688</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">i2</span><span class="p">.</span><span class="nx">DeepUnderstandingComponent</span><span class="p">,</span> <span class="p">[],</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span>
        <span class="p">],</span>
        <span class="kd">function</span> <span class="p">(</span><span class="nx">_ck</span><span class="p">,</span> <span class="nx">_v</span><span class="p">)</span> <span class="p">{</span> <span class="nx">_ck</span><span class="p">(</span><span class="nx">_v</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="p">},</span> <span class="kc">null</span><span class="p">);</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">DeepUnderstandingComponentNgFactory</span> <span class="o">=</span> <span class="nx">i0</span><span class="p">.</span><span class="nx">Éµccf</span><span class="p">(</span><span class="dl">"</span><span class="s2">ng-component</span><span class="dl">"</span><span class="p">,</span> <span class="nx">i2</span><span class="p">.</span><span class="nx">DeepUnderstandingComponent</span><span class="p">,</span> <span class="nx">View_DeepUnderstandingComponent_Host_0</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">[]);</span>
<span class="k">export</span> <span class="p">{</span> <span class="nx">DeepUnderstandingComponentNgFactory</span> <span class="k">as</span> <span class="nx">DeepUnderstandingComponentNgFactory</span> <span class="p">};</span>
<span class="c1">//# sourceMappingURL=deep-understanding-aot.component.ngfactory.js.map</span>
</code></pre></div></div>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨ ngfactory æ–‡ä»¶é‡Œæœ‰:</p>
<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">View_{COMPONENT}{COUNTER}</code>(View_DeepUnderstandingComponent_0) æ˜¯ï¼šthe internal componentï¼Œè´Ÿè´£(æ ¹æ®template)æ¸²æŸ“å‡ºç»„ä»¶çš„è§†å›¾å’Œè¿›è¡Œå˜åŒ–æ£€æµ‹ã€‚</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">View_{COMPONENT}_Host{COUNTER}</code>(View_DeepUnderstandingComponent_Host_0) æ˜¯ï¼šthe internal host componentï¼Œè´Ÿè´£æ¸²æŸ“å‡ºå®¿ä¸»å…ƒç´  &lt; app-compiler &gt; &lt; / app-compiler &gt; ï¼Œå¹¶ä¸”ä½¿ç”¨ â€œthe internal componentâ€ ç®¡ç†ç»„ä»¶çš„å†…éƒ¨è§†å›¾ï¼Œä¹Ÿæ˜¯é€šè¿‡è¿™ä¸ªæ„å»ºæ•´ä¸ªç»„ä»¶æ ‘ã€‚</p>
  </li>
</ul>

<p>åœ¨ View_DeepUnderstandingComponent_0 çš„è§†å›¾åˆ›å»ºå’Œå˜åŒ–æ£€æµ‹ä»£ç å¦‚ä¸‹ï¼š
<img src="/assets/images/posts/angular/angular-compiler08.png" alt="angular-compiler" height="100%" width="100%" /></p>

<p>å…³ç³»å›¾å¦‚ä¸‹ï¼š
<img src="/assets/images/posts/angular/angular-compiler09.png" alt="angular-compiler" height="100%" width="100%" /></p>

<p>æ€»ç»“æ¥è¯´ï¼šAoT ä¹‹åï¼ŒHTML æ¨¡æ¿æ–‡ä»¶ä¼šè¢«ç¼–è¯‘æˆä¸€ä¸ªè§†å›¾(es6)ï¼Œåœ¨è¿™ä¸ªè§†å›¾é‡Œä¼šæŠŠé¡µé¢å…ƒç´ (div h1 h2)éƒ½æ¸²æŸ“å‡ºæ¥ï¼Œå¹¶ä¸”ç”Ÿæˆç»‘å®šå’Œå˜åŒ–æ£€æµ‹ä»£ç ï¼ŒåŒæ—¶ä¹Ÿ host component çš„ä¿¡æ¯ã€‚</p>

<p>å…¶å® ngfactory å°±æ˜¯ Component Viewã€‚åœ¨<code class="language-plaintext highlighter-rouge">*.ngfactory.js</code>è¿‡ç¨‹ä¸­ï¼Œngc ä¼šæŠŠæ‰€æœ‰å¯èƒ½å‘ç”Ÿå˜åŒ–çš„<code class="language-plaintext highlighter-rouge">DOM Nodes/Elements</code>éƒ½æ‰¾å‡ºæ¥ï¼Œç„¶åç»™è¿™äº›<code class="language-plaintext highlighter-rouge">DOM Nodes/Elements</code>ç”Ÿæˆ<code class="language-plaintext highlighter-rouge">Bindings</code>ï¼Œè¿™äº›<code class="language-plaintext highlighter-rouge">Bindings</code>é‡Œä¼šè®°å½•<code class="language-plaintext highlighter-rouge">Element Name/Expression/OldValue</code>ï¼Œä¸€æ—¦æœ‰å¼‚æ­¥äº‹ä»¶å‘ç”Ÿï¼ˆClickäº‹ä»¶æˆ–è€…æ˜¯HttpRequestï¼‰å°±ä¼šè¢«<code class="language-plaintext highlighter-rouge">ngZone</code>æ•è·åˆ°ï¼Œç„¶åè§¦å‘<code class="language-plaintext highlighter-rouge">Change Detection</code>ï¼Œä¹Ÿå°±æ˜¯ä¼šä»<code class="language-plaintext highlighter-rouge">Root Component</code>å¼€å§‹ï¼Œä»ä¸Šåˆ°ä¸‹æ£€æŸ¥æ‰€æœ‰ç»„ä»¶çš„<code class="language-plaintext highlighter-rouge">Bindings</code>ä¹Ÿå°±æ˜¯å‰é¢æåˆ°çš„<code class="language-plaintext highlighter-rouge">Component View</code>ï¼Œå¯¹æ¯”<code class="language-plaintext highlighter-rouge">NewVaule</code>å’Œ<code class="language-plaintext highlighter-rouge">OldValue</code>ï¼Œå¦‚æœä¸ä¸€è‡´å°±ä¼šæŠŠæ–°å€¼æ›´æ–°åˆ°é¡µé¢ï¼ŒåŒæ—¶æŠŠæ–°å€¼æ›´æ–°ä¸ºæ—§å€¼ï¼ˆè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬ç»å¸¸æåˆ°çš„è„æ£€æŸ¥æœºåˆ¶<code class="language-plaintext highlighter-rouge">Dirty Checking</code>ï¼‰</p>

<h2 id="aot-å¯¹æ€§èƒ½çš„å½±å“">AoT å¯¹æ€§èƒ½çš„å½±å“</h2>
<p>ä¸ç®¡æ˜¯ JiT è¿˜æ˜¯ AoTï¼Œæœ€ç»ˆçš„ç»“æœæ–‡ä»¶æ˜¯ä¸€æ ·çš„ã€‚JiT ç¼–è¯‘çš„ bundle æ–‡ä»¶ï¼Œåœ¨æµè§ˆå™¨æ¸²æŸ“ä¹‹å‰éœ€è¦ä¸‹è½½ compiler æºç ï¼Œç„¶å compiler æºç å¯¹ JiT çš„ bundle æ–‡ä»¶è¿›è¡Œç¼–è¯‘ï¼Œä¹Ÿä¼šåœ¨æœ¬åœ°ç”Ÿæˆ<code class="language-plaintext highlighter-rouge">*.ngfactory.js</code>æ–‡ä»¶ï¼Œæœ€åè¿›è¡Œæ¸²æŸ“ã€‚åœ¨æµè§ˆå™¨é‡Œå…ˆç¼–è¯‘å†æ¸²æŸ“è‚¯å®šæ²¡æœ‰ AoT ç›´æ¥åœ¨æµè§ˆå™¨é‡Œæ¸²æŸ“æ€§èƒ½é«˜ã€‚</p>

<p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ç‚¹å¥½å¤„æ˜¯ï¼ŒAoT æŠŠæ¨¡æ¿æ–‡ä»¶ç¼–è¯‘æˆ es6 æ–‡ä»¶ï¼Œå¯ä»¥åš Tree-Shakingï¼Œä¹Ÿä¼šæé«˜æ€§èƒ½ã€‚</p>
:ET